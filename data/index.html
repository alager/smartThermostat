<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.css">
	<link rel="stylesheet" href="mario.css">

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.10/d3.min.js" type="application/javascript"></script>
	<script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js" type="application/javascript"></script>

	<title>Lager Stat</title>

<script>
const gateway = `ws://${window.location.hostname}/ws`;
var websocket;
var chart;
var data;
const chartHeight = 500;

function initWebSocket() {
	console.log('Trying to open a WebSocket connection...');
	websocket = new WebSocket(gateway);
	websocket.onopen = onOpen;
	websocket.onclose = onClose;
	websocket.onmessage = onMessage; // <-- add this line
}

function onOpen(event) {
	console.log('Connection opened');
}

function onClose(event) {
	console.log('Connection closed');
	setTimeout(initWebSocket, 2000);
}

function onMessage(event) 
{
	//debug
	// console.log( "DEBUG")
	// console.log( event.data );
	// console.log( "end DEBUG")

	var data = event.data;

	if( typeof( data ) != "string" )
	{
		// these are not the droids we're looking for
		return;
	}

	// data is a string array that look like this:
	// data_type:data,data,data
	const dataMsg = data.split( ":" );
	const dataType = dataMsg[ 0 ];
	const rawData = dataMsg[ 1 ];

	if( dataType == "tempSet" )
	{
		console.log( "DEBUG tempSet");
		document.getElementById('tempSet').innerHTML = parseFloat( rawData ).toFixed( 1 );
	}
	else
	if( dataType == "telemetry" )
	{
		// split the string by "," into an array
		const dataArry =	rawData.split( "," );
		const mode =		dataArry[ 0 ];
		const tempSetting =	dataArry[ 1 ];
		const tempAvg =		dataArry[ 2 ];
		const humidAvg =	dataArry[ 3 ];
		const presAvg =		dataArry[ 4 ];

		document.getElementById('temperature').innerHTML = parseFloat( tempAvg ).toFixed( 2 );
		document.getElementById('tempSet').innerHTML = parseFloat( tempSetting ).toFixed( 1 );

		var modeStr;
		if( mode == 0 )
			modeStr = "Off";
		else
		if( mode == 1 )
			modeStr = "Cooling";
		else
		if( mode == 2 )
			modeStr = "Heating";

		document.getElementById('mode').innerHTML = modeStr;
		
		// draw an XY line chart
		data = thermLineChart( tempAvg, humidAvg, presAvg );
		d3.select('#chart svg')    //Select the <svg> element you want to render the chart in.   
			.datum(data)         //Populate the <svg> element with chart data...
			.call(chart);          //Finally, render the chart!
	}
	else
	if( dataType == "modeSet" )
	{
		const mode = rawData;
		var modeStr;
		if( mode == 0 )
			modeStr = "Off";
		else
		if( mode == 1 )
			modeStr = "Cooling";
		else
		if( mode == 2 )
			modeStr = "Heating";

		document.getElementById('mode').innerHTML = modeStr;
	}
}



// graphing javascript
/*These lines are all chart setup.  Pick and choose which chart features you want to utilize. */
function addGraph()
{
	chart = nv.models.lineChart()
		.margin({ left: 100 })  //Adjust chart margins to give the x-axis some breathing room.
		.useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!
		.duration(350)  //how fast do you want the lines to transition?
		.showLegend(true)       //Show the legend, allowing users to turn on/off line series.
		.showYAxis(true)        //Show the y-axis
		.showXAxis(true)        //Show the x-axis
		.height( chartHeight )	// set the height
		;

	chart.xAxis     //Chart x-axis settings
		.axisLabel('Time (10s)')
		.tickFormat(d3.format(',r'));

	chart.yAxis     //Chart y-axis settings
		.axisLabel('Temperature (Â°F)')
		.tickFormat(d3.format('.02f'));


	d3.select('#chart').append( 'svg' )    //add the <svg> element you want to render the chart in.  
		.attr("height", chartHeight ) 
		.datum(data)         //Populate the <svg> element with chart data...
		.call(chart);          //Finally, render the chart!


	//Update the chart when window resizes.
	nv.utils.windowResize(chart.update);
	return chart;
};


// make a line chart of the temperature data
// TODO: add humidity and pressure too
var temp=[], hum=[], pres=[];
var chartIdx=0;
function thermLineChart( temperature, humidity, pressure )
{
	// push an {xy} object onto the array
	temp.push( {x: chartIdx, y: temperature} );
	hum.push( {x: chartIdx, y: humidity} );
	pres.push({ x: chartIdx, y: pressure});

	chartIdx++;
	if( chartIdx > 1000 )
	{
		// reset the array
		temp.length=0;
		hum.length = 0;
		pres.length = 0;
		chartIdx=0;
	}

	// return an array of objects
	return [
		{
			values: temp,
			key: "Temperature",
			color: "#2ca02c"
		},
		{
			values: hum,
			key: "Humidity",
			color: "#203020"
		},
		{
			values: pres,
			key: "Pressure",
			color: "#f02010"
		}
	];
}


function initButtons()
{
	document.getElementById('clickUp').addEventListener('click', clickUp);
	document.getElementById('clickDown').addEventListener('click', clickDown);
	document.getElementById('clickMode').addEventListener('click', clickMode);
}

function clickUp()
{
	websocket.send( "temperatureUp" );
}


function clickDown()
{
	websocket.send( "temperatureDown" );
}

function clickMode()
{
	websocket.send( "modeClick" );
}

document.addEventListener("DOMContentLoaded", function(event) 
{
    // Your code to run since DOM is loaded and ready
	initWebSocket();
	initButtons();
	addGraph();
	
});



</script>
	</head>
	<body>
		<div>
			<!--Mario interface-->
			<div class="container">
				<div class="sprite blockSprite blockPosition"></div>
				<div class="sprite marioStanding middleRight"></div>
				<div class="sprite marioJumping middleRightJumping"></div>
				<div class="sprite pipeSprite pipePosition"></div>

			</div>
			<button id="clickUp">Up</button>
			<button id="clickDown">Down</button>
		</div>
		<!--This is the controls deleopment div below-->
		<div hidden>
			<h1>Lager Stat</h1>
			<div>
				<button id="clickUp">Up</button> <button id="clickDown">Down</button>
				<button id="clickMode">Mode</button>
			</div>
			Temperature: <span id="temperature">00.00</span>&deg;F<br>
			TempSet: <span id="tempSet">00.00</span>&deg;F
			Mode: <span id="mode"></span>
			<div class='with-3d-shadow with-transitions' >
				<div id="chart"></div>
			</div>
		</div>
	</body>
</html>